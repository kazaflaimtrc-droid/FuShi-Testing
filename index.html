<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <title>ç¦é£Ÿå°åŠ©æ‰‹</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    .chat-wrapper { max-width: 420px; margin: 0 auto; border: 1px solid #ddd; border-radius: 8px; }
    .chat-header { padding: 12px 16px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .chat-body { padding: 12px 16px; max-height: 520px; overflow-y: auto; }
    .msg { margin-bottom: 8px; }
    .msg-bot { color: #222; }
    .msg-user { text-align: right; color: #0066cc; }
    .input-row { border-top: 1px solid #eee; padding: 8px; display: flex; gap: 8px; }
    .input-row input { flex: 1; padding: 6px 8px; }
    .input-row button { padding: 6px 12px; }
    a { color: #0066cc; text-decoration: none; }
  </style>
</head>
<body>
<div class="chat-wrapper">
  <div class="chat-header">
    <div>ç¦é£Ÿå°åŠ©æ‰‹</div>
    <button id="langToggle">ä¸­æ–‡ / EN</button>
  </div>
  <div id="chat" class="chat-body"></div>
  <div class="input-row">
    <input id="userInput" placeholder="è«‹è©±ç•€æˆ‘çŸ¥ä½ å˜…å•é¡Œï¼Œä¾‹å¦‚ï¼šæœ‰å’©å¥½é£Ÿã€å¹«æˆ‘è¨‚ä½â€¦" />
    <button id="sendBtn">é€å‡º</button>
  </div>
</div>

<script>
  // ====== Menu Data ç”±å¾Œç«¯ API è¼‰å…¥ ======
  let menuData = [];    // [{period, item, meat, price}, ...]
  let isZh = true;

  // ç”¨ Apps Script Web App API è®€ Google Sheet
  async function loadMenuFromSheet() {
    const url = 'https://script.google.com/macros/s/ä½ çš„-exec-URL/exec?type=menu'; // <-- æ”¹æˆä½ å¯¦éš› Web App URL
    try {
      const res = await fetch(url);
      if (!res.ok) {
        console.error('loadMenuFromSheet error', res.status, res.statusText);
        return;
      }
      menuData = await res.json();
      console.log('menu loaded, size =', menuData.length);
    } catch (e) {
      console.error('loadMenuFromSheet exception', e);
    }
  }

  // ====== UI åŸºæœ¬ ======
  const chatEl = document.getElementById('chat');
  const inputEl = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const langBtn = document.getElementById('langToggle');

  function addBot(text) {
    const div = document.createElement('div');
    div.className = 'msg msg-bot';
    div.innerHTML = text;          // ç”¨ innerHTML æ”¯æ´ <br>
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function addUser(text) {
    const div = document.createElement('div');
    div.className = 'msg msg-user';
    div.textContent = text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function renderGreeting() {
    if (isZh) {
      addBot('å“ˆå›‰ï½æ­¡è¿åšŸåˆ°ã€Œç¦é£Ÿã€ï¼æˆ‘ä¿‚ä½ å˜…é£²é£Ÿå°åŠ©æ‰‹ ğŸ˜‰');
      addBot('ä½ å¯ä»¥å¥½è‡ªç„¶å’å•æˆ‘ï¼Œä¾‹å¦‚ï¼šæœ‰å’©å¥½é£Ÿã€ä»Šæ—¥é£Ÿå’©å¥½ã€å¹«æˆ‘è¨‚ä½ã€åˆ°æœƒï¼å¤§é‡è¨‚è³¼ã€å¤–è³£ã€æœ‰å†‡å„ªæƒ ç­‰ç­‰ã€‚');
      addBot('ä½ è€Œå®¶æœ€æƒ³æˆ‘å¹«ä½ åšå•²å’©å‘¢ï¼Ÿ');
      addBot('å¦‚æœæš«æ™‚æœªè«—åˆ°ï¼Œè¦ç‡å®Œæ•´é¤ç‰Œå¯ä»¥æ’³ï¼š<a href="https://heyzine.com/flip-book/FuShiMenu" target="_blank">FuShi Menu</a>');
      addBot('ä½ å¯ä»¥è©¦å“å’å•æˆ‘ï¼šæˆ‘æƒ³é£Ÿç‰›ã€ä»Šæ—¥é£Ÿå’©å¥½ã€å¹«æˆ‘è¨‚ä½ã€å¤§é‡è¨‚è³¼ã€åˆ°æœƒ ç­‰ç­‰ã€‚');
    } else {
      addBot('Hi, welcome to FuShi! I am your dining assistant.');
      addBot('You can ask things like: what to eat today, recommendations, reservation, bulk purchase, catering, promotions, etc.');
      addBot('What can I help you with now?');
    }
  }

  // ====== Intent åˆ¤æ–· ======
  function detectIntent(text) {
    const t = text.toLowerCase();

    if (
      t.includes('é£Ÿå’©å¥½') ||
      t.includes('æœ‰å’©å¥½é£Ÿ') ||
      t.includes('æœ‰ä¹œå¥½é£Ÿ') ||
      t.includes('æ¨è–¦') ||
      t.includes('æ¨ä»‹') ||
      t.includes('recommend') ||
      t.includes('suggest') ||
      t.includes('what to eat')
    ) {
      return 'eatToday';
    }

    if (t.includes('è¨‚ä½') || t.includes('reservation') || t.includes('book a table')) {
      return 'reservation';
    }

    if (t.includes('å¤§é‡è¨‚è³¼') || t.includes('bulk') || t.includes('corporate order')) {
      return 'bulk';
    }

    if (t.includes('åˆ°æœƒ') || t.includes('catering')) {
      return 'catering';
    }

    if (t.includes('å¤–è³£') || t.includes('å¤–é€') || t.includes('online order')) {
      return 'order';
    }

    return 'fallback';
  }

  // å¾å¥å­ä¸­æŠ½è‚‰é¡ï¼ˆä¸­ï¼‹è‹±ï¼‰
  function chooseMeatTagFromText(text) {
    const t = text.toLowerCase();

    if (t.includes('ç‰›') || t.includes('beef')) return 'Beef';
    if (t.includes('é›') || t.includes('chicken')) return 'Chicken';
    if (t.includes('è±¬') || t.includes('pork')) return 'Pork';
    if (t.includes('é­š') || t.includes('seafood') || t.includes('sea food')) return 'Sea Food';
    if (t.includes('ç´ ') || t.includes('vegan') || t.includes('vegetarian')) return 'Vegan';

    return null;
  }

  // ====== æ¨è–¦èœå¼ï¼ˆåŒ…å«åƒ¹éŒ¢ï¼Œä¸€è¡Œä¸€å€‹ itemï¼‰ ======
  function recommendDishes(meatTag) {
    console.log('recommendDishes meatTag =', meatTag);
    const tag = meatTag.toLowerCase();

    const list = menuData.filter(d => {
      const m = (d.meat || '').toLowerCase();
      if (tag === 'beef')     return m.includes('beef') || m.includes('ç‰›');
      if (tag === 'chicken')  return m.includes('chicken') || m.includes('é›');
      if (tag === 'pork')     return m.includes('pork') || m.includes('è±¬');
      if (tag === 'sea food') return m.includes('sea food') || m.includes('é­š');
      if (tag === 'vegan')    return m.includes('vegan') || m.includes('ç´ ');
      return false;
    });

    console.log('recommended list size =', list.length);

    if (list.length === 0) {
      return isZh
        ? 'æš«æ™‚æœªæœ‰ç¬¦åˆæ¢ä»¶å˜…èœå¼ï¼Œä¸å¦‚ç‡å“å®Œæ•´ FuShi Menuï¼Ÿ'
        : 'I could not find matching dishes for that choice. Please check the full FuShi Menu.';
    }

    const shuffled = list.slice().sort(() => Math.random() - 0.5).slice(0, 3);

    let lines;
    if (isZh) {
      lines = shuffled.map(d => `â€¢ ${d.item} - $${d.price}`);
      return 'æˆ‘å¹«ä½ å–ºé¤ç‰Œæ€å’—å¹¾æ¬¾å¯èƒ½å•±ä½ å˜…èœå¼ï¼š<br>' + lines.join('<br>');
    } else {
      lines = shuffled.map(d => `â€¢ ${d.item} - HKD ${d.price}`);
      return 'Here are some dishes that may suit you:<br>' + lines.join('<br>');
    }
  }

  // ====== é£Ÿå’©å¥½ Flow ======
  function flowEatToday(text) {
    const meatTag = chooseMeatTagFromText(text);
    if (!meatTag) {
      if (isZh) {
        addBot('ä»Šæ—¥æœ‰å†‡ç‰¹åˆ¥æƒ³é£Ÿå˜…è‚‰é¡æˆ–æµ·é®®å‘¢ï¼Ÿå¯ä»¥è©±æˆ‘çŸ¥ï¼šç‰›ã€é›ã€è±¬ã€é­šã€ç´ ã€‚');
      } else {
        addBot('Any preference today? Beef, chicken, pork, seafood or vegan?');
      }
      return;
    }

    const reply = recommendDishes(meatTag);
    addBot(reply);
    if (isZh) {
      addBot('å¦‚æœå•±å¿ƒæ°´ï¼Œå¯ä»¥è©±æˆ‘çŸ¥ã€Œå¹«æˆ‘è½å–®ã€æˆ–è€…ç›´æ¥å» Online Order å¹³å°ã€‚');
    } else {
      addBot('If you like any of them, tell me â€œplace orderâ€ or go to the online order platform.');
    }
  }

  // ====== å…¶ä»– Flowï¼ˆç°¡åŒ–ç‰ˆï¼‰ ======
  function flowReservation() {
    if (isZh) {
      addBot('è¨‚ä½æ–¹é¢ï¼Œä½ å¯ä»¥è©±æˆ‘çŸ¥æ—¥æœŸã€äººæ•¸åŒæ™‚é–“ï¼Œæˆ‘æœƒå¹«ä½ æ•´åˆè³‡æ–™ï¼Œå†äº¤ç•€åŒäº‹ WhatsApp è·Ÿé€²ã€‚');
    } else {
      addBot('For reservation, please tell me date, number of guests and time, and our staff will follow up via WhatsApp.');
    }
  }

  function flowBulk() {
    if (isZh) {
      addBot('å¤§é‡è¨‚è³¼æ–¹é¢ï¼Œæˆ‘å¯ä»¥å…ˆæ ¹æ“šäººæ•¸æ¨ä»‹å¹¾æ¬¾å¥—é¤ï¼Œä¹‹å¾Œå†è½‰å» bulk order è¡¨å–®ä¿¾ä½ æ€ã€‚');
    } else {
      addBot('For bulk purchase, I can suggest some set menus based on headcount, then direct you to the bulk order form.');
    }
  }

  function flowCatering() {
    if (isZh) {
      addBot('åˆ°æœƒæœå‹™å¯ä»¥ç¶“ FuShi Catering Menu ç¶²ç«™å¡«è¡¨ï¼Œæˆ‘å¯ä»¥å…ˆ roughly å¹«ä½ æ€å¹¾æ¬¾ menuï¼Œå†äº¤ç•€åŒäº‹ç¢ºèªã€‚');
    } else {
      addBot('For catering, please refer to the FuShi Catering Menu form; I can help you choose a tentative menu first.');
    }
  }

  function flowOrder() {
    if (isZh) {
      addBot('ä½ å¯ä»¥ç¶“ç·šä¸Šé»é¤å¹³å°è½å–®ï¼š<a href="https://fushi.softether.net/byod/byod.aspx?data=hwZVZ2BqRSxraTV9YHWCRmw3D3D" target="_blank">Online Order</a>ã€‚å¦‚æœæƒ³æˆ‘å…ˆå¹«ä½ æ€èœï¼Œå¯ä»¥è©±æˆ‘çŸ¥ã€Œä»Šæ—¥é£Ÿå’©å¥½ã€ã€‚');
    } else {
      addBot('You can place order via our online ordering platform. If you want recommendations first, say â€œwhat to eat todayâ€.');
    }
  }

  function flowFallback() {
    if (isZh) {
      addBot('æˆ‘æš«æ™‚æœªå®Œå…¨è½å¾—æ˜ä½ å˜…æ„æ€ ğŸ˜…');
      addBot('ä½ å¯ä»¥è©¦å“å’å•æˆ‘ï¼š<br>â€¢ ä»Šæ—¥é£Ÿå’©å¥½ï¼Ÿ<br>â€¢ æˆ‘æƒ³é£Ÿç‰›<br>â€¢ å¹«æˆ‘è¨‚ä½<br>â€¢ æœ‰å†‡å¤§é‡è¨‚è³¼ / åˆ°æœƒï¼Ÿ');
    } else {
      addBot("I'm not fully sure what you mean.");
      addBot('You may try asking:<br>â€¢ what to eat today<br>â€¢ I want beef<br>â€¢ I need a reservation<br>â€¢ any bulk purchase or catering');
    }
  }

  // ====== ä¸»è™•ç† ======
  function handleUserInput() {
    const text = inputEl.value.trim();
    if (!text) return;
    addUser(text);
    inputEl.value = '';

    const intent = detectIntent(text);
    console.log('intent =', intent);

    if (intent === 'eatToday')   return flowEatToday(text);
    if (intent === 'reservation') return flowReservation();
    if (intent === 'bulk')       return flowBulk();
    if (intent === 'catering')   return flowCatering();
    if (intent === 'order')      return flowOrder();
    return flowFallback();
  }

  // ====== äº‹ä»¶ç¶å®š ======
  sendBtn.addEventListener('click', handleUserInput);
  inputEl.addEventListener('keydown', e => {
    if (e.key === 'Enter') handleUserInput();
  });

  langBtn.addEventListener('click', () => {
    isZh = !isZh;
    chatEl.innerHTML = '';
    renderGreeting();
  });

  // ====== åˆå§‹åŒ– ======
  (async function init() {
    await loadMenuFromSheet();
    renderGreeting();
  })();
</script>
</body>
</html>
