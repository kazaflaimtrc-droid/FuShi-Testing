// ====== Menu Data ç”±å¾Œç«¯ API è¼‰å…¥ ======
let menuData = [];
let isZh = true;

async function loadMenuFromSheet() {
  const url = 'https://script.google.com/macros/s/ä½ çš„-exec-URL/exec?type=menu';
  try {
    const res = await fetch(url);
    if (!res.ok) {
      console.error('loadMenuFromSheet error', res.status, res.statusText);
      return;
    }
    menuData = await res.json();
    console.log('menu loaded, size =', menuData.length);
  } catch (e) {
    console.error('loadMenuFromSheet exception', e);
  }
}

// ====== UI åŸºæœ¬ ======
const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const langBtn = document.getElementById('langToggle');

// Hot key å®¹å™¨
let hotKeyBar = null;

function addBot(text) {
  const div = document.createElement('div');
  div.className = 'msg msg-bot';
  div.innerHTML = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function addUser(text) {
  const div = document.createElement('div');
  div.className = 'msg msg-user';
  div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

// å»º hot key bar
function renderHotKeys() {
  if (!hotKeyBar) {
    hotKeyBar = document.createElement('div');
    hotKeyBar.style.marginTop = '8px';
    hotKeyBar.style.display = 'flex';
    hotKeyBar.style.flexWrap = 'wrap';
    hotKeyBar.style.gap = '6px';
    chatEl.appendChild(hotKeyBar);
  } else {
    hotKeyBar.innerHTML = '';
  }

  const keysZh = [
    'ä»Šæ—¥é£Ÿå’©å¥½',
    'æˆ‘æƒ³é£Ÿç‰›',
    'æˆ‘æƒ³é£Ÿé›',
    'æˆ‘æƒ³é£Ÿè±¬',
    'è¨‚ä½',
    'å¤§é‡è¨‚è³¼',
    'åˆ°æœƒ',
    'Online Order'
  ];
  const keysEn = [
    'What to eat today',
    'I want beef',
    'I want chicken',
    'I want pork',
    'Reservation',
    'Bulk purchase',
    'Catering',
    'Online order'
  ];

  const keys = isZh ? keysZh : keysEn;

  keys.forEach(k => {
    const btn = document.createElement('button');
    btn.textContent = k;
    btn.style.padding = '4px 8px';
    btn.style.borderRadius = '12px';
    btn.style.border = '1px solid #ddd';
    btn.style.background = '#f7f7f7';
    btn.style.cursor = 'pointer';
    btn.onclick = () => {
      inputEl.value = k;
      handleUserInput();
    };
    hotKeyBar.appendChild(btn);
  });

  chatEl.scrollTop = chatEl.scrollHeight;
}

function renderGreeting() {
  if (isZh) {
    addBot('å“ˆå›‰ï½æ­¡è¿åšŸåˆ°ã€Œç¦é£Ÿã€ï¼æˆ‘ä¿‚ä½ å˜…é£²é£Ÿå°åŠ©æ‰‹ ğŸ˜‰');
    addBot('ä½ å¯ä»¥å•ï¼šæœ‰å’©å¥½é£Ÿã€ä»Šæ—¥é£Ÿå’©å¥½ã€å¹«æˆ‘è¨‚ä½ã€åˆ°æœƒï¼å¤§é‡è¨‚è³¼ã€å¤–è³£ã€æœ‰å†‡å„ªæƒ ç­‰ç­‰ã€‚');
    addBot('ä½ è€Œå®¶æœ€æƒ³æˆ‘å¹«ä½ åšå•²å’©å‘¢ï¼Ÿ');
  } else {
    addBot('Hi, welcome to FuShi! I am your dining assistant.');
    addBot('You can ask: what to eat today, reservation, bulk purchase, catering, online order, promotions, etc.');
  }
  renderHotKeys();
}

// ====== Intent åˆ¤æ–· ======
function detectIntent(text) {
  const t = text.toLowerCase();

  if (
    t.includes('é£Ÿå’©å¥½') ||
    t.includes('æœ‰å’©å¥½é£Ÿ') ||
    t.includes('æœ‰ä¹œå¥½é£Ÿ') ||
    t.includes('recommend') ||
    t.includes('æ¨ä»‹') ||
    t.includes('æ¨è–¦') ||
    t.includes('suggest') ||
    t.includes('what to eat')
  ) return 'eatToday';

  if (t.includes('è¨‚ä½') || t.includes('reservation') || t.includes('book a table'))
    return 'reservation';

  if (t.includes('å¤§é‡è¨‚è³¼') || t.includes('bulk') || t.includes('corporate order'))
    return 'bulk';

  if (t.includes('åˆ°æœƒ') || t.includes('catering'))
    return 'catering';

  if (t.includes('å¤–è³£') || t.includes('online order') || t.includes('å¤–é€'))
    return 'order';

  return 'fallback';
}

// è‚‰é¡ keyword
function chooseMeatTagFromText(text) {
  const t = text.toLowerCase();
  if (t.includes('ç‰›') || t.includes('beef')) return 'Beef';
  if (t.includes('é›') || t.includes('chicken')) return 'Chicken';
  if (t.includes('è±¬') || t.includes('pork')) return 'Pork';
  if (t.includes('é­š') || t.includes('seafood') || t.includes('sea food')) return 'Sea Food';
  if (t.includes('ç´ ') || t.includes('vegan') || t.includes('vegetarian')) return 'Vegan';
  return null;
}

// ====== æ¨è–¦èœå¼ ======
function recommendDishes(meatTag) {
  console.log('recommendDishes meatTag =', meatTag);
  const tag = meatTag.toLowerCase();

  const list = menuData.filter(d => {
    const m = (d.meat || '').toLowerCase();
    if (tag === 'beef')     return m.includes('beef') || m.includes('ç‰›');
    if (tag === 'chicken')  return m.includes('chicken') || m.includes('é›');
    if (tag === 'pork')     return m.includes('pork') || m.includes('è±¬');
    if (tag === 'sea food') return m.includes('sea food') || m.includes('é­š');
    if (tag === 'vegan')    return m.includes('vegan') || m.includes('ç´ ');
    return false;
  });

  console.log('recommended list size =', list.length);

  if (list.length === 0) {
    return isZh
      ? 'æš«æ™‚æœªæœ‰ç¬¦åˆæ¢ä»¶å˜…èœå¼ï¼Œä¸å¦‚ç‡å“å®Œæ•´ FuShi Menuï¼Ÿ'
      : 'I could not find matching dishes for that choice. Please check the full FuShi Menu.';
  }

  const shuffled = list.slice().sort(() => Math.random() - 0.5).slice(0, 3);
  let lines;

  if (isZh) {
    lines = shuffled.map(d => `â€¢ ${d.item} - $${d.price}`);
    return 'æˆ‘å¹«ä½ å–ºé¤ç‰Œæ€å’—å¹¾æ¬¾å¯èƒ½å•±ä½ å˜…èœå¼ï¼š<br>' + lines.join('<br>');
  } else {
    lines = shuffled.map(d => `â€¢ ${d.item} - HKD ${d.price}`);
    return 'Here are some dishes that may suit you:<br>' + lines.join('<br>');
  }
}

// ====== å„ Flow ======
function flowEatToday(text) {
  const meatTag = chooseMeatTagFromText(text);
  if (!meatTag) {
    if (isZh) addBot('ä»Šæ—¥æœ‰å†‡ç‰¹åˆ¥æƒ³é£Ÿå˜…è‚‰é¡æˆ–æµ·é®®å‘¢ï¼Ÿå¯ä»¥è©±æˆ‘çŸ¥ï¼šç‰›ã€é›ã€è±¬ã€é­šã€ç´ ã€‚');
    else addBot('Any preference today? Beef, chicken, pork, seafood or vegan?');
    return;
  }
  const reply = recommendDishes(meatTag);
  addBot(reply);
}

function flowReservation() {
  if (isZh) {
    addBot('è¨‚ä½æ–¹é¢ï¼Œä½ å¯ä»¥å¡«å‘¢ä»½ formï¼š<a href="https://ä½ åŸæœ¬ç”¨é–‹å˜…è¨‚ä½Form" target="_blank">è¨‚ä½è¡¨æ ¼</a>ã€‚');
  } else {
    addBot('For reservation, please fill this form: <a href="https://ä½ åŸæœ¬ç”¨é–‹å˜…è¨‚ä½Form" target="_blank">Reservation form</a>.');
  }
}

function flowBulk() {
  if (isZh) {
    addBot('å¤§é‡è¨‚è³¼å¯ä»¥ç”¨å‘¢ä»½è¡¨ï¼š<a href="https://ä½ åŸæœ¬ç”¨é–‹å˜…BulkForm" target="_blank">å¤§é‡è¨‚è³¼è¡¨æ ¼</a>ã€‚');
  } else {
    addBot('For bulk purchase, please use this form: <a href="https://ä½ åŸæœ¬ç”¨é–‹å˜…BulkForm" target="_blank">Bulk order form</a>.');
  }
}

function flowCatering() {
  if (isZh) {
    addBot('åˆ°æœƒå¯ä»¥å»å‘¢åº¦æ€é¤å–®åŒå¡«è³‡æ–™ï¼š<a href="https://ä½ åŸæœ¬ç”¨é–‹å˜…CateringForm" target="_blank">åˆ°æœƒè¡¨æ ¼</a>ã€‚');
  } else {
    addBot('For catering, please go here: <a href="https://ä½ åŸæœ¬ç”¨é–‹å˜…CateringForm" target="_blank">Catering form</a>.');
  }
}

function flowOrder() {
  if (isZh) {
    addBot('ä½ å¯ä»¥ç¶“ç·šä¸Šé»é¤å¹³å°è½å–®ï¼š<a href="https://fushi.softether.net/byod/byod.aspx?data=hwZVZ2BqRSxraTV9YHWCRmw3D3D" target="_blank">Online Order</a>ã€‚');
  } else {
    addBot('You can place order via: <a href="https://fushi.softether.net/byod/byod.aspx?data=hwZVZ2BqRSxraTV9YHWCRmw3D3D" target="_blank">Online Order</a>.');
  }
}

function flowFallback() {
  if (isZh) {
    addBot('æˆ‘æš«æ™‚æœªå®Œå…¨è½å¾—æ˜ä½ å˜…æ„æ€ ğŸ˜…');
    addBot('ä½ å¯ä»¥è©¦å“æ’³ä¸‹é¢å•²å¿«æ·éµï¼Œä¾‹å¦‚ï¼šä»Šæ—¥é£Ÿå’©å¥½ã€æˆ‘æƒ³é£Ÿç‰›ã€è¨‚ä½ã€å¤§é‡è¨‚è³¼ã€åˆ°æœƒã€‚');
  } else {
    addBot("I'm not fully sure what you mean ğŸ˜…");
  }
}

// ====== ä¸»è™•ç† ======
function handleUserInput() {
  const text = inputEl.value.trim();
  if (!text) return;
  addUser(text);
  inputEl.value = '';

  const intent = detectIntent(text);
  console.log('intent =', intent);

  if (intent === 'eatToday')   return flowEatToday(text);
  if (intent === 'reservation') return flowReservation();
  if (intent === 'bulk')       return flowBulk();
  if (intent === 'catering')   return flowCatering();
  if (intent === 'order')      return flowOrder();
  return flowFallback();
}

// ====== äº‹ä»¶ & åˆå§‹åŒ– ======
sendBtn.addEventListener('click', handleUserInput);
inputEl.addEventListener('keydown', e => {
  if (e.key === 'Enter') handleUserInput();
});

langBtn.addEventListener('click', () => {
  isZh = !isZh;
  chatEl.innerHTML = '';
  hotKeyBar = null;
  renderGreeting();
});

(async function init() {
  await loadMenuFromSheet();
  renderGreeting();
})();

</body>
</html>

