<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fushi Food Assistant</title>
  <style>
    /* ä¿ç•™ä½ åŸæœ¬å˜…æ‰€æœ‰ CSS æ¨£å¼ */
    body { font-family: Arial, sans-serif; background-color: #f5f5f5; display: flex; justify-content: center; align-items: stretch; min-height: 100vh; margin: 0; padding: 40px 10px; }
    .chat-container { background: #ffffff; width: 100%; max-width: 420px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 16px; display: flex; flex-direction: column; gap: 8px; }
    .top-bar { font-weight: bold; display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .lang-btn { font-size: 12px; padding: 4px 6px; border-radius: 10px; border: 1px solid #ccc; background: #f0f0f0; cursor: pointer; }
    .chat-window { flex: 1; min-height: 260px; max-height: 420px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: #fafafa; }
    .msg { margin-bottom: 8px; line-height: 1.4; font-size: 14px; }
    .bot { color: #333; }
    .user { text-align: right; color: #007bff; }
    .input-area { display: flex; gap: 6px; margin-top: 4px; }
    .input-area input { flex: 1; padding: 8px 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
    .input-area button { padding: 8px 10px; border-radius: 4px; border: none; background: #28a745; color: #fff; font-size: 14px; cursor: pointer; white-space: nowrap; }
    #reservationForm, #cateringForm { font-size: 13px; border-top: 1px solid #eee; margin-top: 6px; padding-top: 4px; display:none; }
    #reservationForm label, #cateringForm label { display: inline-block; width: 110px; }
    #rsvWaBtn, #cateringWaBtn { margin-top: 4px; padding: 6px 8px; font-size: 13px; border-radius: 4px; border: none; background: #25d366; color: #fff; cursor: pointer; width: 100%; }
    a { color: #007bff; }
    @media (max-width: 600px) { body { padding: 0; } .chat-container { max-width: 100%; height: 100vh; border-radius: 0; } .chat-window { max-height: none; } }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="top-bar">
      <span id="titleText">ç¦é£Ÿå°åŠ©æ‰‹</span>
      <button id="langBtn" class="lang-btn">ä¸­æ–‡ / EN</button>
    </div>
    <div id="chat" class="chat-window"></div>

    <!-- è¨‚ä½è¡¨å–® -->
    <div id="reservationForm">
      <div style="margin-bottom:4px;"><label id="lblRsvPax"></label><input id="rsvPax" type="number" min="1" style="width:80px;"></div>
      <div style="margin-bottom:4px;"><label id="lblRsvDate"></label><input id="rsvDate" type="date"></div>
      <div style="margin-bottom:4px;"><label id="lblRsvTime"></label><input id="rsvTime" type="time"></div>
      <div style="margin-bottom:4px;"><label id="lblRsvPhone"></label><input id="rsvPhone" type="tel" style="width:140px;"></div>
      <button id="rsvWaBtn"></button>
    </div>

    <!-- åˆ°æœƒè¡¨å–® -->
    <div id="cateringForm">
      <div style="margin-bottom:4px;"><label id="lblCatOccasion"></label><input id="catOccasion" type="text"></div>
      <div style="margin-bottom:4px;"><label id="lblCatPax"></label><input id="catPax" type="text"></div>
      <div style="margin-bottom:4px;"><label id="lblCatDate"></label><input id="catDate" type="date"></div>
      <div style="margin-bottom:4px;"><label id="lblCatTime"></label><input id="catTime" type="time"></div>
      <div style="margin-bottom:4px;"><label id="lblCatItems"></label><textarea id="catItems" style="width:100%; min-height:40px;"></textarea></div>
      <div style="margin-bottom:4px;"><label id="lblCatContact"></label><input id="catContact" type="text"></div>
      <button id="cateringWaBtn"></button>
    </div>

    <div class="input-area">
      <input id="userInput" type="text">
      <button id="sendBtn">é€å‡º</button>
    </div>
  </div>

  <script>
    // ğŸ”´ è«‹ç¢ºä¿å‘¢åº¦ä¿‚ä½ æœ€æ–°éƒ¨ç½²å˜… URL
    const MENU_API_URL = 'https://script.google.com/macros/s/1ttd8WfW8V-5JwTv9-aTWlji1qW8N3f2jUjO13zMqtqc/exec?type=menu';

    const chat = document.getElementById('chat');
    const input = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const langBtn = document.getElementById('langBtn');
    const titleText = document.getElementById('titleText');
    const rsvForm = document.getElementById('reservationForm');
    const cateringForm = document.getElementById('cateringForm');

    let currentLang = 'zh';
    let menuData = [];

    const texts = {
      title: { zh: 'ç¦é£Ÿå°åŠ©æ‰‹', en: 'Fushi Food Assistant' },
      langBtn: { zh: 'ä¸­æ–‡ / EN', en: 'EN / ä¸­æ–‡' },
      welcome1: { zh: 'å“ˆå›‰ï½ æ­¡è¿åšŸåˆ°ã€Œç¦é£Ÿã€ï¼æˆ‘ä¿‚ä½ å˜…é£²é£Ÿå°åŠ©æ‰‹ ğŸ‘‹', en: 'Hi! Welcome to "Fushi". I am your food assistant ğŸ‘‹' },
      welcome2: { zh: 'ä½ å¯ä»¥å•æˆ‘ï¼šæœ‰å’©æ¨ä»‹ã€è¨‚ä½ã€åˆ°æœƒã€å¤–è³£ç­‰ã€‚', en: 'You can ask: recommendations, booking, catering, takeaway etc.' },
      askMain: { zh: 'ä½ è€Œå®¶æœ€æƒ³æˆ‘å¹«ä½ åšå•²ä¹œï¼Ÿ', en: 'What would you like me to help you with?' },
      eatAsk: { zh: 'æƒ³é£Ÿå’©è‚‰é¡æˆ–æµ·é®®ï¼Ÿä¾‹å¦‚ï¼šç‰›ã€é›ã€è±¬ã€æµ·é®®ã€ç´ é£Ÿï½', en: 'Any preference? E.g. Beef, Chicken, Pork, Seafood or Vegan.' },
      menuText: { zh: 'é›»å­é¤ç‰Œï¼š', en: 'E-menu:' },
      rsvDone: { zh: 'è«‹åˆ° WhatsApp ç¢ºèªï¼Œå””è©²æ™’ï¼', en: 'Please confirm on WhatsApp, thank you!' }
    };

    // ğŸ”´ ä¿®æ”¹å¾Œå˜…æ•¸æ“šåŠ è¼‰é‚è¼¯
    async function loadMenuFromSheet() {
      try {
        const res = await fetch(MENU_API_URL);
        const data = await res.json();
        // ç›´æ¥å­˜å„² API è¿”å›å˜…çµæ§‹
        menuData = data.map(item => ({
          period: item.period,
          nameZh: item.item_zh || item.item,
          nameEn: item.item_en || item.item,
          meat: item.meat, // ä¾å®¶ API æœƒè¿”å› "Beef", "Chicken" ç­‰è‹±æ–‡æ¨™ç±¤
          price: item.price
        }));
        console.log('Menu Data Loaded:', menuData);
      } catch (err) {
        console.error('API Error:', err);
        addBot('æŠ±æ­‰ï¼Œè¼‰å…¥é¤ç‰Œå¤±æ•—ã€‚');
      }
    }

    function addBot(text) {
      const div = document.createElement('div');
      div.className = 'msg bot';
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function addBotHTML(html) {
      const div = document.createElement('div');
      div.className = 'msg bot';
      div.innerHTML = html;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // ğŸ”´ ä¿®æ”¹å¾Œå˜…æ¨è–¦é‚è¼¯ï¼šåŒ¹é…è‹±æ–‡ meat æ¨™ç±¤
    function recommendDishes(keyword) {
      const t = keyword.toLowerCase();
      let meatTag = '';
      if (t.includes('ç‰›') || t.includes('beef')) meatTag = 'beef';
      if (t.includes('é›') || t.includes('chicken')) meatTag = 'chicken';
      if (t.includes('è±¬') || t.includes('pork')) meatTag = 'pork';
      if (t.includes('æµ·é®®') || t.includes('seafood')) meatTag = 'sea food';
      if (t.includes('ç´ ') || t.includes('vegan')) meatTag = 'vegan';

      if (!meatTag) {
        addBot(texts.eatAsk[currentLang]);
        return;
      }

      const list = menuData.filter(d => d.meat.toLowerCase() === meatTag).slice(0, 3);

      if (list.length === 0) {
        addBot(currentLang === 'zh' ? 'æš«æ™‚æœªæœ‰å‘¢é¡æ¨è–¦ï¼Œç‡å“é¤ç‰Œï¼Ÿ' : 'No items found, check our menu?');
      } else {
        addBot(currentLang === 'zh' ? 'å¹«ä½ æ€å’—å¹¾æ¬¾ï¼š' : 'Here are some picks:');
        const lines = list.map(d => `â€¢ ${currentLang === 'zh' ? d.nameZh : d.nameEn}${d.price ? ' ($' + d.price + ')' : ''}`);
        addBotHTML(lines.join('<br>'));
      }
      addBotHTML('ğŸ‘‰ <a href="https://heyzine.com/flip-book/FuShiç¦é£ŸMenu" target="_blank">Full Menu</a>');
    }

    function handleKeyword(raw) {
      const t = raw.toLowerCase();
      const userDiv = document.createElement('div');
      userDiv.className = 'msg user';
      userDiv.textContent = raw;
      chat.appendChild(userDiv);

      if (t.includes('é£Ÿå’©') || t.includes('æ¨ä»‹') || t.includes('eat') || t.includes('recommend')) {
        recommendDishes(raw);
      } else if (t.includes('è¨‚ä½') || t.includes('book')) {
        rsvForm.style.display = 'block';
        addBot('è«‹å¡«å¯«è¨‚ä½è³‡æ–™ï¼š');
      } else if (t.includes('åˆ°æœƒ') || t.includes('catering')) {
        cateringForm.style.display = 'block';
        addBot('è«‹å¡«å¯«åˆ°æœƒè³‡æ–™ï¼š');
      } else {
        addBot(texts.welcome2[currentLang]);
      }
    }

    sendBtn.onclick = () => { handleKeyword(input.value); input.value = ''; };
    input.onkeydown = (e) => { if(e.key==='Enter') sendBtn.onclick(); };
    
    // åˆå§‹åŒ–
    loadMenuFromSheet().then(() => {
        addBot(texts.welcome1['zh']);
        addBot(texts.askMain['zh']);
    });

    // è¡¨å–®æŒ‰éˆ•é‚è¼¯ (WhatsApp)
    document.getElementById('rsvWaBtn').onclick = () => {
      const text = `æˆ‘æƒ³è¨‚ä½ï¼š
äººæ•¸ï¼š${document.getElementById('rsvPax').value}
æ—¥æœŸï¼š${document.getElementById('rsvDate').value}`;
      window.open(`https://wa.me/85264067605?text=${encodeURIComponent(text)}`);
    };
  </script>
</body>
</html>